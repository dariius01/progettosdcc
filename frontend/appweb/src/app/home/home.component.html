<div class="container">
  <!-- Barra login/logout + icona cronologia -->
  <div class="auth-links">
    <button *ngIf="!isLoggedIn" routerLink="/login" class="btn-auth">Accedi</button>
    <button *ngIf="!isLoggedIn" routerLink="/register" class="btn-auth">Registrati</button>

    <ng-container *ngIf="isLoggedIn">
      <button (click)="logout()" class="btn-auth">Logout</button>
      <mat-icon
        (click)="toggleCronologia()"
        class="cronologia-icon"
        title="Visualizza cronologia"
      >
        access_time
      </mat-icon>
    </ng-container>
  </div>

  <h1 class="titolo">ðŸ“° Realizza un nuovo articolo!</h1>

  <!-- Barra di ricerca -->
  <div class="barra-ricerca-riga">
    <div class="barra-ricerca">
      <mat-icon class="icona-lente">search</mat-icon>
      <input
        type="text"
        [(ngModel)]="query"
        (keydown.enter)="cerca()"
        placeholder="Cerca notizie"
        class="input-elegante"
      />
    </div>
  </div>

  <!-- Bottone aggiungi manualmente -->
  <div class="azioni-manuali">
    <button (click)="vaiAdAggiuntaManuale()" class="btn-manuale">
      <mat-icon class="icon-plus">add</mat-icon>
      Aggiungi manualmente
    </button>

    <button
      *ngIf="articoliManuali.length > 0"
      (click)="toggleMostraArticoliManuali()"
      class="btn-manuale"
    >
      <mat-icon class="icon-eye">visibility</mat-icon>
      {{ mostraArticoliManuali ? 'Nascondi articoli aggiunti' : 'Mostra articoli aggiunti' }}
    </button>
  </div>

  <!-- Lista articoli manuali -->
  <div *ngIf="mostraArticoliManuali" class="lista-articoli-manuali">
    <ul>
      <li
        *ngFor="let articolo of articoliManuali"
        [class.selezionato]="articoloManualeSelezionato === articolo"
        style="cursor:pointer; padding: 5px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;"
        (click)="selezionaArticoloManuale(articolo)"
      >
        <span>{{ articolo.titolo }}</span>
        <button
          class="btn-cestino"
          (click)="rimuoviArticoloManuale(articolo, $event)"
          aria-label="Elimina articolo"
          title="Elimina articolo"
        >
          <mat-icon>delete</mat-icon>
        </button>
      </li>
    </ul>

    <div *ngIf="articoloManualeSelezionato" class="dettaglio-articolo-manuale" style="margin-top: 10px; padding: 10px; border: 1px solid #ccc;">
      <h3>{{ articoloManualeSelezionato.titolo }}</h3>
      <h4 *ngIf="articoloManualeSelezionato.sottotitolo"><em>{{ articoloManualeSelezionato.sottotitolo }}</em></h4>
      <p>{{ articoloManualeSelezionato.testo }}</p>
    </div>
  </div>

  <!-- Messaggio di errore generale -->
  <div *ngIf="errore" class="messaggio-errore">{{ errore }}</div>

  <!-- Lista risultati ricerca -->
  <div class="lista-risultati">
    <div
      *ngFor="let notizia of risultati"
      class="card-notizia"
      [class.selezionata]="isSelezionata(notizia)"
    >
      <label class="check-container">
        <input
          type="checkbox"
          [checked]="isSelezionata(notizia)"
          (change)="toggleSelezione(notizia, $event)"
        />
        <span class="custom-check"></span>
      </label>

      <div class="contenuto-notizia">
        <h3>
          <a
            *ngIf="notizia.url"
            [href]="notizia.url"
            target="_blank"
            rel="noopener noreferrer"
            class="titolo-notizia-link"
          >
            {{ notizia.titolo }}
          </a>
          <span *ngIf="!notizia.url">{{ notizia.titolo }}</span>
        </h3>

        <p *ngIf="notizia.sottotitolo"><em>{{ notizia.sottotitolo }}</em></p>
        <p *ngIf="notizia.source" class="fonte">Fonte: {{ notizia.source }}</p>
      </div>
    </div>
  </div>

  <!-- Generazione articolo -->
  <div class="area-generazione" *ngIf="(risultati.length > 0) || (articoliManuali.length > 0)">
    <button
      (click)="generaNotizia()"
      [disabled]="loadingGenerazione || (notizieSelezionate.length === 0 && articoliManuali.length === 0)"
      [class.attivo]="notizieSelezionate.length > 0 || articoliManuali.length > 0"
    >
      {{ loadingGenerazione ? 'Generazione in corso...' : 'Genera Articolo' }}
    </button>

    <div *ngIf="erroreGenerazione" class="messaggio-errore">
      {{ erroreGenerazione }}
    </div>
  </div>
</div>

<!-- CRONOLOGIA FUORI DAL CONTAINER -->
<div *ngIf="mostraCronologia" class="lista-cronologia-flottante">
  <h3>Cronologia articoli</h3>

  <div *ngIf="erroreCronologia" class="messaggio-errore">
    {{ erroreCronologia }}
  </div>

  <ul *ngIf="!erroreCronologia">
    <li *ngFor="let notizia of cronologiaNotizie" class="item-cronologia">
      <a 
        *ngIf="notizia.id" 
        [routerLink]="['/notizia', notizia.id]" 
        [state]="{ query: query, risultati: risultati, notizieSelezionate: notizieSelezionate }" 
        class="titolo-cronologia-link"
      >
        {{ notizia.titolo }}
      </a>
    </li>
  </ul>


  <p *ngIf="!erroreCronologia && cronologiaNotizie.length === 0">
    Nessuna notizia in cronologia.
  </p>
</div>
