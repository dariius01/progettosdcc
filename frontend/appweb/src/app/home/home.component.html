<div class="container">
  <div class="auth-links">
    <!-- Mostra solo l'icona di login se l'utente non Ã¨ loggato -->
    <button *ngIf="!isLoggedIn" routerLink="/login" class="btn-auth btn-login" title="Accedi">
      <span class="btn-text">Accedi</span>
      <mat-icon>login</mat-icon>
    </button>

    <!-- Logout per utenti loggati -->
    <ng-container *ngIf="isLoggedIn">
      <button (click)="logout()" class="btn-auth btn-login" title="Logout">
        <span class="btn-text">Logout</span>
        <mat-icon>logout</mat-icon>
      </button>
    </ng-container>
  </div>

  <h1 class="titolo"> SportGenerator</h1>
  <h2 class="sottotitolo">ðŸ“° Genera il tuo articolo sportivo!</h2>

  <!-- Barra di ricerca -->
  <div class="barra-ricerca-riga">
    <div class="barra-ricerca">
      <mat-icon class="icona-lente">search</mat-icon>
      <input
        type="text"
        [(ngModel)]="query"
        (keydown.enter)="cerca()"
        placeholder="Cerca notizie"
        class="input-barra"
      />
    </div>
  </div>

  <!-- Bottone aggiungi manualmente + cronologia -->
  <div class="azioni-manuali">
    <div class="azioni-sx">
      <button (click)="vaiAdAggiuntaManuale()" class="btn-manuale">
        <mat-icon class="icon-plus">add</mat-icon>
        Aggiungi manualmente
      </button>

      <button
        *ngIf="articoliManuali.length > 0"
        (click)="toggleMostraArticoliManuali()"
        class="btn-manuale"
      >
        <mat-icon class="icon-eye">visibility</mat-icon>
        {{ mostraArticoliManuali ? 'Nascondi articoli aggiunti' : 'Mostra articoli aggiunti' }}
      </button>
    </div>

    <!-- Icona cronologia solo se loggati -->
    <mat-icon *ngIf="isLoggedIn" (click)="toggleCronologia()" class="cronologia-icon" title="Visualizza cronologia">
      access_time
    </mat-icon>
  </div>

  <!-- Lista articoli manuali -->
  <div *ngIf="mostraArticoliManuali" class="lista-articoli-manuali">
    <ul>
      <li *ngFor="let articolo of articoliManuali"
        [class.selezionato]="articoloManualeSelezionato === articolo"
        class="articolo-item"
      >
        <span class="titolo-articolo" (click)="apriPopup(articolo)">{{ articolo.titolo }}</span>

        <button
          class="btn-cestino"
          (click)="rimuoviArticoloManuale(articolo, $event)"
          aria-label="Elimina articolo"
          title="Elimina articolo"
        >
          <mat-icon>delete</mat-icon>
        </button>
      </li>
    </ul>
  </div>

  <!-- Popup articolo -->
 <div *ngIf="articoloPopup" class="overlay" (click)="chiudiPopup()">
    <div class="popup" (click)="$event.stopPropagation()">
      <button class="btn-chiudi" (click)="chiudiPopup()" aria-label="Chiudi">&times;</button>
      <h2>{{ articoloPopup.titolo }}</h2>
      <h4 *ngIf="articoloPopup.sottotitolo"><em>{{ articoloPopup.sottotitolo }}</em></h4>
      <p>{{ articoloPopup.testo }}</p>
    </div>
  </div>

  <div *ngIf="errore" class="messaggio-errore">{{ errore }}</div>

  <div class="lista-risultati">
    <div
      *ngFor="let notizia of risultati"
      class="card-notizia"
      [class.selezionata]="isSelezionata(notizia)"
    >
      <label class="check-container">
        <input
          type="checkbox"
          [checked]="isSelezionata(notizia)"
          (change)="toggleSelezione(notizia, $event)"
        />
        <span class="custom-check"></span>
      </label>

      <div class="contenuto-notizia">
        <h3>
          <a
            *ngIf="notizia.url"
            [href]="notizia.url"
            target="_blank"
            rel="noopener noreferrer"
            class="titolo-notizia-link"
          >
            {{ notizia.titolo }}
          </a>
          <span *ngIf="!notizia.url">{{ notizia.titolo }}</span>
        </h3>

        <p *ngIf="notizia.sottotitolo"><em>{{ notizia.sottotitolo }}</em></p>
        <p *ngIf="notizia.source" class="fonte">Fonte: {{ notizia.source }}</p>
      </div>
    </div>

    <!-- Nessun risultato -->
    <div *ngIf="!loading && nessunRisultato" class="nessun-risultato">
      Mi dispiace, non ci sono articoli relativi a questo tema ðŸ˜¢
    </div>
  </div>

  <!-- Generazione articolo -->  
  <div class="area-generazione" *ngIf="(risultati.length > 0) || (articoliManuali.length > 0)">
    <button
      (click)="generaNotizia()"
      [disabled]="loadingGenerazione || (notizieSelezionate.length === 0 && articoliManuali.length === 0)"
      [class.attivo]="notizieSelezionate.length > 0 || articoliManuali.length > 0"
    >
      {{ loadingGenerazione ? 'Generazione in corso...' : 'Genera Articolo' }}
    </button>

    <!-- Spinner di caricamento -->
    <div *ngIf="loadingGenerazione" class="loading-overlay">
      <div class="spinner"></div>
      <p>Sto generando il tuo articolo...</p>
    </div>

    <div *ngIf="erroreGenerazione" class="messaggio-errore">
      {{ erroreGenerazione }}
    </div>
  </div>
</div>

 <!-- Tendina cronologia -->
<div *ngIf="mostraCronologia" class="lista-cronologia-flottante">
  <button class="chiudi-cronologia" (click)="mostraCronologia = false">&times;</button>
  <h3>Cronologia articoli</h3>
  <div *ngIf="erroreCronologia" class="messaggio-errore">{{ erroreCronologia }}</div>
  <ul *ngIf="!erroreCronologia">
    <li *ngFor="let notizia of cronologiaNotizie" class="item-cronologia">
      <a *ngIf="notizia.id" [routerLink]="['/notizia', notizia.id]" [state]="{ query: query, risultati: risultati, notizieSelezionate: notizieSelezionate }" class="titolo-cronologia-link">
        {{ notizia.titolo }}
      </a>
    </li>
  </ul>
  <p *ngIf="!erroreCronologia && cronologiaNotizie.length === 0">Nessuna notizia in cronologia.</p>
</div>

<div *ngIf="loginAlert" class="login-alert">
  {{ loginAlert }}
</div>